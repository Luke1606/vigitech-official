generator client {
	provider = "prisma-client-js"
  output = "../node_modules/.prisma/client"
  previewFeatures = ["multiSchema"]
}

datasource db {
	provider  = "postgresql"
	url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
    schemas   = ["public", "user_data", "tech_survey"]
}


model User {
  id                             String               @id @default(uuid())
  clerkId                        String               @unique
  
  createdAt                      DateTime             @default(now())
  updatedAt                      DateTime             @updatedAt
  
  preferences                   UserPreferences?
  insertedItems                 SurveyItem[]
  subscribedItems               UserSubscribedItem[]
  hiddenItems                   UserHiddenItem[]
  lists                         UserItemList[]

  @@schema("user_data")
}


enum NotificationChannel {
    IN_APP
    EMAIL
    PUSH
    SMS

    @@schema("user_data")
}

enum Theme {
    DARK
    LIGHT
    SYSTEM

    @@schema("user_data")
}

enum Language {
    EN
    ES

    @@schema("user_data")
}

enum Frequency {
    EVERY_10_MINUTES
    EVERY_30_MINUTES
    HOURLY
    EVERY_6_HOURS
    DAILY
    EVERY_TWO_DAYS
    EVERY_FOUR_DAYS
    WEEKLY

    @@schema("user_data")
}

model UserPreferences {
    id                             String               @id @default(uuid())
    theme                          Theme                @default(SYSTEM)
    language                       Language             @default(ES)
    defaultNotificationChannel     NotificationChannel  @default(IN_APP)
    analysisFrequency              Frequency            @default(EVERY_6_HOURS)
    recommendationsUpdateFrequency Frequency            @default(DAILY)

    createdAt                      DateTime             @default(now())
    updatedAt                      DateTime             @updatedAt

	userId                         String               @unique
    user                           User?                @relation(fields: [userId], references: [id])

    @@schema("user_data")
}


model UserSubscribedItem {
  id                             String               @id @default(uuid())
  userId                         String
  user                           User                 @relation(fields: [userId], references: [id])
  itemId                         String
  item                           SurveyItem           @relation(fields: [itemId], references: [id])
  
  createdAt                      DateTime             @default(now())
  
  @@unique([userId, itemId])
  @@schema("user_data")
}


model UserHiddenItem {
  id                             String               @id @default(uuid())
  userId                         String
  user                           User                 @relation(fields: [userId], references: [id])
  itemId                         String
  item                           SurveyItem           @relation(fields: [itemId], references: [id])
  
  createdAt                      DateTime             @default(now())
  
  @@unique([userId, itemId])
  @@schema("user_data")
}


model UserItemList {
    id                             String               @id @default(uuid())    
    name                           String
    preferredNotificationChannel   NotificationChannel  @default(IN_APP)

    createdAt                      DateTime             @default(now())
    updatedAt                      DateTime             @updatedAt
    
    ownerId                        String
    owner                          User                 @relation(fields: [ownerId], references: [id])
    items                          SurveyItem[]         @relation("ListItems")

    @@schema("user_data")
}

model Report {
    id                             String               @id @default(uuid())
    startDate                      DateTime
    endDate                        DateTime             @default(now())
    
    createdAt                      DateTime             @default(now())
    updatedAt                      DateTime             @updatedAt

    items                          SurveyItem[]         @relation("ReportItems")

    @@schema("user_data")
}


// Modelos para el schema 'tech_survey'
enum RadarQuadrant {
    BUSSINESS_INTEL
    SCIENTIFIC_STAGE
    SUPPORT_PLATTFORMS_AND_TECHNOLOGIES
    LANGUAGES_AND_FRAMEWORKS

    @@schema("tech_survey")
}

enum RadarRing {
    ADOPT
    TEST
    SUSTAIN
    HOLD
    UNKNOWN

    @@schema("tech_survey")
}

enum RawDataSource {
  GITHUB
  GITLAB
  KAGGLE
  CROSSREF
  OPENALEX
  DOCKERHUB
  NEWSAPI
  HACKERNEWS
  STACKEXCHANGE
  NPM
  PYPI
  RSS

  @@schema("tech_survey")
}

enum RawDataType {
  REPOSITORY
  DATASET
  ARTICLE
  PACKAGE
  QUESTION
  NEWS_ITEM
  BLOG_POST
  RESEARCH_PAPER

  @@schema("tech_survey")
}

model SurveyItem {
  id                             String               @id @default(uuid())
  title                          String
  summary                        String
  
  // Almacena un array de IExternalReference. Permite múltiples IDs por fuente.
  externalReferences             Json                 @default("[]") // Changed to default "[]" for empty array
  
  // Almacena la metadata consolidada del cuadrante antes de la clasificación AI
  consolidatedMetadata           Json                 @default("{}") 
  
  // Almacena los insights finales proporcionados por el Agente AI
  insights                       Json                 @default("{}")

  radarQuadrant                  RadarQuadrant
  radarRing                      RadarRing            @default(UNKNOWN)

  createdAt                      DateTime             @default(now())
  updatedAt                      DateTime             @updatedAt

  analysisHistory                ItemAnalysis[]  
  lists                          UserItemList[]       @relation("ListItems")
  reports                        Report[]             @relation("ReportItems")
  
  insertedBy                     User?                @relation(fields: [insertedById], references: [id])
  insertedById                   String?
  subscribedBy                   UserSubscribedItem[]
  hiddenBy                       UserHiddenItem[]

  @@schema("tech_survey")
}


// Stores the raw, merged metadata from all APIs in a quadrant for a specific analysis run
model ItemMetadata {
  id           String       @id @default(uuid())
  fetchedAt    DateTime     @default(now())
  mergedData   Json

  analysis     ItemAnalysis?

  @@schema("tech_survey")
}

enum Trending {
    UP
    DOWN
    STABLE
    UNSTABLE

    @@schema("tech_survey")
}

enum AccesibilityLevel {
    FREE
    PAID

    @@schema("tech_survey")
}

// Stores the merged insights from all AI agents for a specific analysis run
model QuadrantInsights {
  id                String            @id @default(uuid())
  citations         Int
  downloads         Int
  relevance         Float
  accesibilityLevel AccesibilityLevel
  trending          Trending

  analysis          ItemAnalysis?

  @@schema("tech_survey")
}

// Represents a single analysis run for a SurveyItem at a point in time
model ItemAnalysis {
  id         String   @id @default(uuid())
  analyzedAt DateTime @default(now())

  itemId     String
  item       SurveyItem @relation(fields: [itemId], references: [id])

  metadataId String       @unique
  metadata   ItemMetadata @relation(fields: [metadataId], references: [id])

  insightsId String           @unique
  insights   QuadrantInsights @relation(fields: [insightsId], references: [id])

  @@schema("tech_survey")
}

// Nuevo modelo para almacenar datos brutos de las APIs
model RawData {
  id          String        @id @default(uuid())
  source      RawDataSource
  dataType    RawDataType
  content     Json
  processedAt DateTime?
  collectedAt DateTime      @default(now())

  @@schema("tech_survey")
}
