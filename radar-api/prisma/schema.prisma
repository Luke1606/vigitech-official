generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/client"
  engineType      = "library"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id               String                 @id @default(uuid())
  clerkId          String                 @unique

  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  preferences      UserPreferences?
  insertedItems    Item[]
  subscribedItems  UserSubscribedItem[]
  hiddenItems      UserHiddenItem[]
  lists            UserItemList[]
  reports          Report[]
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
}

enum Theme {
  DARK
  LIGHT
  SYSTEM
}

enum Language {
  EN
  ES
}

enum Frequency {
  EVERY_10_MINUTES
  EVERY_30_MINUTES
  HOURLY
  EVERY_6_HOURS
  DAILY
  EVERY_TWO_DAYS
  EVERY_FOUR_DAYS
  WEEKLY
}

model UserPreferences {
  id                           String                 @id @default(uuid())
  theme                           Theme               @default(SYSTEM)
  language                        Language            @default(ES)
  defaultNotificationChannel      NotificationChannel @default(IN_APP)
  reClasificationFrequency        Frequency           @default(EVERY_6_HOURS)
  recommendationsUpdateFrequency  Frequency           @default(DAILY)

  createdAt                       DateTime            @default(now())
  updatedAt                       DateTime            @updatedAt

  userId                          String              @unique
  user                            User?               @relation(fields: [userId], references: [id])
}

model UserSubscribedItem {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  itemId    String
  item      Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt DateTime   @default(now())

  @@unique([userId, itemId])
}

model UserHiddenItem {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  itemId    String
  item      Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt DateTime   @default(now())

  @@unique([userId, itemId])
}

model UserItemList {
  id                           String              @id @default(uuid())
  name                         String
  preferredNotificationChannel NotificationChannel @default(IN_APP)

  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt

  ownerId                      String
  owner                        User                @relation(fields: [ownerId], references: [id])
  items                        Item[]              @relation("ListItems")
}

model Report {
  id        String   @id @default(uuid())

  creatorId       String
  creator         User      @relation(fields: [creatorId], references: [id])

  startDate       DateTime
  endDate         DateTime  @default(now())

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  items           Item[]    @relation("ReportItems")
}

enum Field {
  BUSSINESS_INTEL
  SCIENTIFIC_STAGE
  SUPPORT_PLATTFORMS_AND_TECHNOLOGIES
  LANGUAGES_AND_FRAMEWORKS
}

enum Classification {
  ADOPT
  TEST
  SUSTAIN
  HOLD
}

enum RawDataSource {
  ARXIV_ORG
  CROSS_REF
  DEV_TO
  DOCKER_HUB
  GITHUB
  GITHUB_OCTOVERSE
  GITLAB
  GOOGLE_BOOKS
  HACKER_NEWS
  HASHNODE
  HUGGING_FACE_HUB
  KAGGLE
  KUBERNETES
  MAVEN
  MEDIA_WIKI
  MEETUP
  NEWS_API
  NPM
  OPEN_ALEX
  PAPERS_WITH_CODE
  PRODUCT_HUNT
  PYPI
  REDDIT
  RSS
  SEMANTIC_SCHOLAR
  STACK_EXCHANGE
  STACK_OVERFLOW_SURVEY
}

enum RawDataType {
  CODE_ASSET
  TEXT_CONTENT
  ACADEMIC_PAPER
  REPORT_OR_PRODUCT
  COMMUNITY_POST
  DATASET
}

model RawData {
  id                 String              @id @default(uuid())
  source             RawDataSource
  dataType           RawDataType
  content            Json // El dato JSON crudo
  processedAt        DateTime?
  collectedAt        DateTime            @default(now())
  
  // Relación con los fragmentos de conocimiento generados
  knowledgeFragments KnowledgeFragment[] 
}

// La unidad atómica de conocimiento vectorizado para RAG
model KnowledgeFragment {
  id                      String              @id @default(uuid())
  // El texto limpio listo para ser inyectado en el Prompt del LLM
  textSnippet             String 
  // El vector denso (embedding) del texto, usando pgvector
  embedding               Unsupported("vector")

  // Almacena métricas estructuradas que viajan con el vector para la Búsqueda Híbrida
  associatedKPIs          Json                @default("{}") 

  // Referencia a la fuente cruda
  sourceRawDataId         String
  sourceRawData           RawData             @relation(fields: [sourceRawDataId], references: [id])

  // Citaciones de la clasificación que usaron este fragmento como evidencia
  citedBy                 ItemCitedFragment[]

  createdAt               DateTime            @default(now())
}

// El objeto de estudio del Radar
model Item {
  id                      String                @id @default(uuid())
  title                   String
  summary                 String

  itemField               Field // El cuadrante del Radar

  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt

  // Campo de optimización de lectura para la vista actual del Radar
  latestClassificationId  String?               @unique 
  latestClassification    ItemClassification?   @relation("LatestClassification", fields: [latestClassificationId], references: [id])
  
  // Transparencia: Lista de fragmentos usados para la última clasificación
  citedFragments          ItemCitedFragment[] 

  // Historial completo de clasificaciones
  classificationHistory  ItemClassification[]  @relation("ItemClassificationHistory") 

  // Relaciones de usuario
  lists                   UserItemList[]        @relation("ListItems")
  reports                 Report[]              @relation("ReportItems")
  insertedBy              User?                 @relation(fields: [insertedById], references: [id])
  insertedById            String?
  subscribedBy            UserSubscribedItem[]
  hiddenBy                UserHiddenItem[]
}

// Representa una ejecución de clasificación (el Historial)
model ItemClassification {
  id                      String                @id @default(uuid())
  analyzedAt              DateTime              @default(now())

  itemId                  String
  item                    Item                  @relation("ItemClassificationHistory", fields: [itemId], references: [id], onDelete: Cascade)

  classification               Classification 

  // El insight textual (justificación) y las métricas de razonamiento del LLM
  insightsValues          Json

  // Relación inversa para el puntero rápido de 'latestClassification'
  itemAsLatest            Item?                 @relation("LatestClassification")
}

// Tabla intermedia para citar qué KnowledgeFragment se usó para la última clasificación de un Item
model ItemCitedFragment {
  id                      String              @id @default(uuid())
  
  // Relación con el Item
  itemId                  String
  item                    Item                @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  // Relación con el Fragmento de Conocimiento
  fragmentId              String
  fragment                KnowledgeFragment   @relation(fields: [fragmentId], references: [id])

  @@unique([itemId, fragmentId])
}